<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36" version="28.2.5">
  <diagram id="system-flow" name="System Flow">
    <mxGraphModel dx="1665" dy="1823" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1920" pageHeight="1080" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="client" value="Frontend (Angular)" style="shape=rectangle;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="50" y="-150" width="180" height="50" as="geometry" />
        </mxCell>
        <mxCell id="backend" value="Backend (Spring Boot)" style="shape=rectangle;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="80" y="-790" width="260" height="40" as="geometry" />
        </mxCell>
        <mxCell id="db" value="Database (PostgreSQL)\nTables: &#xa;short_urls, short_url_accesses" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="1410" y="-110" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="cache" value="TopRankingCache\nTop-100 + Hits&#xa; (code→count)" style="shape=rectangle;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="490" y="-260" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="shortenTitle" value="Flow: Encurtar URL (/shorten)" style="text;align=left;fontStyle=1;fontSize=13" parent="1" vertex="1">
          <mxGeometry x="50" y="880" width="280" height="30" as="geometry" />
        </mxCell>
        <mxCell id="shortenCtrl" value="LinkController\nPOST /shorten" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="50" y="920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="shortenSvc" value="UrlShortenerService.shorten(url, customCode)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="290" y="920" width="260" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hasCustom" value="customCode informado?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="290" y="1000" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="checkDBCustom" value="existsByCode(customCode)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="510" y="1000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="checkCacheCustom" value="cache.containsCode(customCode)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="750" y="1000" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="saveCustom" value="saveAndFlush(ShortUrl)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="750" y="100" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="catchDup" value="DataIntegrityViolationException → DuplicateCodeException (409)" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="970" y="100" width="320" height="50" as="geometry" />
        </mxCell>
        <mxCell id="loopTitle" value="Geração aleatória (até 5 tentativas)" style="text;align=left;fontStyle=1;fontSize=13" parent="1" vertex="1">
          <mxGeometry x="330" y="470" width="280" height="30" as="geometry" />
        </mxCell>
        <mxCell id="genCode" value="generateRandomCode()" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="340" y="530" width="180" height="50" as="geometry" />
        </mxCell>
        <mxCell id="checkCacheGen" value="cache.containsCode(code)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="560" y="530" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="checkDBGen" value="existsByCode(code)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="800" y="530" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="saveGen" value="saveAndFlush(ShortUrl)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="1020" y="530" width="200" height="50" as="geometry" />
        </mxCell>
        <mxCell id="catchCollision" value="DataIntegrityViolationException → Retry nova tentativa" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="420" y="700" width="260" height="60" as="geometry" />
        </mxCell>
        <mxCell id="loopEnd" value="Falha após 5 tentativas → IllegalStateException" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="420" y="780" width="260" height="60" as="geometry" />
        </mxCell>
        <mxCell id="accessTitle" value="Flow: Acesso e Atualização de Cache" style="text;align=left;fontStyle=1;fontSize=13" parent="1" vertex="1">
          <mxGeometry x="50" y="310" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="redirectCtrl" value="Redirect Controller\nGET /{code}" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="50" y="350" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="getByCode" value="UrlShortenerService.getByCode(code)\n1)&#xa; cache.getEntity(code)\n2)&#xa; repo.findByCode(code)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="290" y="350" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="registerAccess" value="registerAccess(shortUrl, ua, referer)\n→ &#xa;save ShortUrlAccess" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="610" y="350" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="afterCommit" value="TransactionSynchronization.afterCommit\n→&#xa; topRankingCache.onAccess(shortUrl)" style="shape=rectangle;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="910" y="350" width="300" height="80" as="geometry" />
        </mxCell>
        <mxCell id="scheduler" value="@Scheduled cada 1 min\n→ &#xa;topRankingCache.refreshTop100()" style="shape=rectangle;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="1250" y="350" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="queriesTitle" value="Consultas e Estatísticas" style="text;align=left;fontStyle=1;fontSize=13" parent="1" vertex="1">
          <mxGeometry x="50" y="470" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rankingEndpoint" value="StatsController /ranking\n→ topRankingCache.getTop() &#xa;(Top-100)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="80" y="-590" width="300" height="70" as="geometry" />
        </mxCell>
        <mxCell id="statsEndpoint" value="StatsController /stats/{code}\n→ &#xa;su = service.getByCode(code)\n→ &#xa;hits = cache.getHits(code) ou accessRepo.countByShortUrl(su)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="420" y="-590" width="420" height="90" as="geometry" />
        </mxCell>
        <mxCell id="listStats" value="UrlShortenerService.listStats(Pageable)\n→&#xa; ShortUrlRepository.findAllStats(Page)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="880" y="-590" width="360" height="70" as="geometry" />
        </mxCell>
        <mxCell id="e1" style="endArrow=classic;strokeColor=#000" parent="1" source="client" target="shortenCtrl" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e2" style="endArrow=classic;strokeColor=#000" parent="1" source="shortenCtrl" target="shortenSvc" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e3" style="endArrow=classic;strokeColor=#000" parent="1" source="shortenSvc" target="hasCustom" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e4" value="Sim" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="hasCustom" target="checkDBCustom" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="checkDBCustom" target="checkCacheCustom" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e6" value="Sim → 409" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="checkDBCustom" target="catchDup" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e7" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="checkCacheCustom" target="saveCustom" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e8" value="Sim → 409" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="checkCacheCustom" target="catchDup" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e9" style="endArrow=classic;strokeColor=#000" parent="1" source="saveCustom" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e10" value="Se customCode ausente" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="shortenSvc" target="genCode" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e11" style="endArrow=classic;strokeColor=#000" parent="1" source="genCode" target="checkCacheGen" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e12" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="checkCacheGen" target="checkDBGen" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e13" value="Sim → retry" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="checkCacheGen" target="genCode" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e14" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="checkDBGen" target="saveGen" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e15" value="Sim → retry" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="checkDBGen" target="genCode" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e16" style="endArrow=classic;strokeColor=#000" parent="1" source="saveGen" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e17" value="Se violar unique(code)" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="saveGen" target="catchCollision" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e18" value="Tentar novamente (máx. 5)" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="catchCollision" target="genCode" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e19" style="endArrow=classic;strokeColor=#000" parent="1" source="client" target="redirectCtrl" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e20" style="endArrow=classic;strokeColor=#000" parent="1" source="redirectCtrl" target="getByCode" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e21" value="Tentativa 1" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1" source="getByCode" target="cache" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e22" value="Fallback" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="getByCode" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e23" style="endArrow=classic;strokeColor=#000" parent="1" source="getByCode" target="registerAccess" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e24" value="INSERT short_url_accesses" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="registerAccess" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e25" value="Após commit" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1" source="registerAccess" target="afterCommit" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e26" value="Atualiza hits e Top-100" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1" source="afterCommit" target="cache" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e27" value="Refresh periódico" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1" source="scheduler" target="cache" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e28" style="endArrow=classic;strokeColor=#000" parent="1" source="client" target="rankingEndpoint" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e29" style="endArrow=classic;strokeColor=#9673a6" parent="1" source="rankingEndpoint" target="cache" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e30" style="endArrow=classic;strokeColor=#000" parent="1" source="client" target="statsEndpoint" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e31" value="Hits se disponível" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1" source="statsEndpoint" target="cache" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e32" value="COUNT(accesses) se não" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1" source="statsEndpoint" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e33" style="endArrow=classic;strokeColor=#000" parent="1" source="client" target="listStats" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e34" value="Query paginada (ORDER BY createdAt DESC)" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1" source="listStats" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
