<mxfile host="app.diagrams.net" modified="2025-10-03T12:00:00.000Z" agent="TraeAI-GPT5" version="20.6.3" type="device">
  <diagram id="system-flow" name="System Flow">
    <mxGraphModel dx="1612" dy="978" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1920" pageHeight="1080" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Section: Actors -->
        <mxCell id="client" value="Frontend (Angular)" style="shape=rectangle;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="40" y="60" width="180" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="backend" value="Backend (Spring Boot)" style="shape=rectangle;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="340" y="20" width="260" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="db" value="Database (PostgreSQL)\nTables: short_urls, short_url_accesses" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="1040" y="60" width="260" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="cache" value="TopRankingCache\nTop-100 + Hits (code→count)" style="shape=rectangle;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="740" y="60" width="260" height="80" as="geometry"/>
        </mxCell>

        <!-- Section: Shorten Flow (/shorten) -->
        <mxCell id="shortenTitle" value="Flow: Encurtar URL (/shorten)" style="text;align=left;fontStyle=1;fontSize=13" vertex="1" parent="1">
          <mxGeometry x="340" y="100" width="280" height="30" as="geometry"/>
        </mxCell>

        <mxCell id="shortenCtrl" value="LinkController\nPOST /shorten" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="340" y="140" width="200" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="shortenSvc" value="UrlShortenerService.shorten(url, customCode)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="580" y="140" width="260" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="hasCustom" value="customCode informado?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="580" y="220" width="180" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="checkDBCustom" value="existsByCode(customCode)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="800" y="220" width="200" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="checkCacheCustom" value="cache.containsCode(customCode)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="1040" y="220" width="220" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="saveCustom" value="saveAndFlush(ShortUrl)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="740" y="310" width="200" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="catchDup" value="DataIntegrityViolationException → DuplicateCodeException (409)" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="960" y="310" width="320" height="50" as="geometry"/>
        </mxCell>

        <!-- Random generation loop -->
        <mxCell id="loopTitle" value="Geração aleatória (até 5 tentativas)" style="text;align=left;fontStyle=1;fontSize=13" vertex="1" parent="1">
          <mxGeometry x="340" y="380" width="280" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="genCode" value="generateRandomCode()" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="340" y="420" width="180" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="checkCacheGen" value="cache.containsCode(code)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="560" y="420" width="200" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="checkDBGen" value="existsByCode(code)?" style="shape=rhombus;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="800" y="420" width="180" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="saveGen" value="saveAndFlush(ShortUrl)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="1020" y="420" width="200" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="catchCollision" value="DataIntegrityViolationException → Retry nova tentativa" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="1240" y="420" width="260" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="loopEnd" value="Falha após 5 tentativas → IllegalStateException" style="shape=rectangle;rounded=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="1240" y="500" width="260" height="60" as="geometry"/>
        </mxCell>

        <!-- Access and Cache Update -->
        <mxCell id="accessTitle" value="Flow: Acesso e Atualização de Cache" style="text;align=left;fontStyle=1;fontSize=13" vertex="1" parent="1">
          <mxGeometry x="40" y="520" width="300" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="redirectCtrl" value="Redirect Controller\nGET /{code}" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="40" y="560" width="200" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="getByCode" value="UrlShortenerService.getByCode(code)\n1) cache.getEntity(code)\n2) repo.findByCode(code)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="280" y="560" width="280" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="registerAccess" value="registerAccess(shortUrl, ua, referer)\n→ save ShortUrlAccess" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="600" y="560" width="260" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="afterCommit" value="TransactionSynchronization.afterCommit\n→ topRankingCache.onAccess(shortUrl)" style="shape=rectangle;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="900" y="560" width="300" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="scheduler" value="@Scheduled cada 1 min\n→ topRankingCache.refreshTop100()" style="shape=rectangle;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="1240" y="560" width="260" height="80" as="geometry"/>
        </mxCell>

        <!-- Queries / APIs -->
        <mxCell id="queriesTitle" value="Consultas e Estatísticas" style="text;align=left;fontStyle=1;fontSize=13" vertex="1" parent="1">
          <mxGeometry x="40" y="680" width="220" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="rankingEndpoint" value="StatsController /ranking\n→ topRankingCache.getTop() (Top-100)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="40" y="720" width="300" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="statsEndpoint" value="StatsController /stats/{code}\n→ su = service.getByCode(code)\n→ hits = cache.getHits(code) ou accessRepo.countByShortUrl(su)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="380" y="720" width="420" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="listStats" value="UrlShortenerService.listStats(Pageable)\n→ ShortUrlRepository.findAllStats(Page)" style="shape=rectangle;rounded=1;fillColor=#fff;strokeColor=#000;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="840" y="720" width="360" height="70" as="geometry"/>
        </mxCell>

        <!-- Edges: Shorten flow -->
        <mxCell id="e1" edge="1" source="client" target="shortenCtrl" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e2" edge="1" source="shortenCtrl" target="shortenSvc" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e3" edge="1" source="shortenSvc" target="hasCustom" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e4" edge="1" source="hasCustom" target="checkDBCustom" value="Sim" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e5" edge="1" source="checkDBCustom" target="checkCacheCustom" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e6" edge="1" source="checkDBCustom" target="catchDup" value="Sim → 409" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e7" edge="1" source="checkCacheCustom" target="saveCustom" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e8" edge="1" source="checkCacheCustom" target="catchDup" value="Sim → 409" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e9" edge="1" source="saveCustom" target="db" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Random loop edges -->
        <mxCell id="e10" edge="1" source="shortenSvc" target="genCode" value="Se customCode ausente" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e11" edge="1" source="genCode" target="checkCacheGen" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e12" edge="1" source="checkCacheGen" target="checkDBGen" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e13" edge="1" source="checkCacheGen" target="genCode" value="Sim → retry" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e14" edge="1" source="checkDBGen" target="saveGen" value="Não" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e15" edge="1" source="checkDBGen" target="genCode" value="Sim → retry" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e16" edge="1" source="saveGen" target="db" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e17" edge="1" source="saveGen" target="catchCollision" value="Se violar unique(code)" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e18" edge="1" source="catchCollision" target="genCode" value="Tentar novamente (máx. 5)" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Access edges -->
        <mxCell id="e19" edge="1" source="client" target="redirectCtrl" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e20" edge="1" source="redirectCtrl" target="getByCode" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e21" edge="1" source="getByCode" target="cache" value="Tentativa 1" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e22" edge="1" source="getByCode" target="db" value="Fallback" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e23" edge="1" source="getByCode" target="registerAccess" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e24" edge="1" source="registerAccess" target="db" value="INSERT short_url_accesses" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e25" edge="1" source="registerAccess" target="afterCommit" value="Após commit" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e26" edge="1" source="afterCommit" target="cache" value="Atualiza hits e Top-100" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e27" edge="1" source="scheduler" target="cache" value="Refresh periódico" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Queries edges -->
        <mxCell id="e28" edge="1" source="client" target="rankingEndpoint" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e29" edge="1" source="rankingEndpoint" target="cache" style="endArrow=classic;strokeColor=#9673a6" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e30" edge="1" source="client" target="statsEndpoint" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e31" edge="1" source="statsEndpoint" target="cache" value="Hits se disponível" style="endArrow=classic;strokeColor=#9673a6;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e32" edge="1" source="statsEndpoint" target="db" value="COUNT(accesses) se não" style="endArrow=classic;strokeColor=#b85450;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e33" edge="1" source="client" target="listStats" style="endArrow=classic;strokeColor=#000" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e34" edge="1" source="listStats" target="db" value="Query paginada (ORDER BY createdAt DESC)" style="endArrow=classic;strokeColor=#000;fontSize=11" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>